{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "dashboardName": {
            "type": "string"
        },
        "dashboardTitle": {
            "type": "string"
        },
        "appInsightsName": {
            "type": "string"
        }
    },
    "variables": {
        "location": "[resourceGroup().location]",
        "subscriptionId": "[subscription().subscriptionId]",
        "resourceGroupName": "[resourceGroup().name]",
        "appInsightsResourceId": "[resourceId(variables('subscriptionId'), variables('resourceGroupName'), 'Microsoft.Insights/components', parameters('appInsightsName'))]"
    },
    "resources": [
        {
            "name": "[parameters('dashboardName')]",
            "apiVersion": "2015-08-01-preview",
            "type": "Microsoft.Portal/dashboards",
            "location": "[variables('location')]",
            "tags": {
                "hidden-title": "[parameters('dashboardTitle')]"
            },
            "properties": {
                "lenses": {
                    "0": {
                        "order": 0,
                        "parts": {
                            "0": {
                                "position": {
                                    "x": 0,
                                    "y": 0,
                                    "rowSpan": 4,
                                    "colSpan": 5
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "ComponentId",
                                            "value": {
                                                "SubscriptionId": "[variables('subscriptionId')]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('appInsightsName')]",
                                                "ResourceId": "[variables('appInsightsResourceId')]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "value": "pageViews\n| where timestamp > ago(24h)\n| summarize Pageviews = count() by timestamp\n| render timechart\n"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "value": {
                                                "xAxis": {
                                                    "name": "timestamp",
                                                    "type": "DateTime"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "Pageviews",
                                                        "type": "Int64"
                                                    }
                                                ],
                                                "splitBy": [],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "PartTitle",
                                            "value": "Analytics"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "value": "[parameters('appInsightsName')]"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "value": "components"
                                        },
                                        {
                                            "name": "ControlType",
                                            "value": "AnalyticsChart"
                                        },
                                        {
                                            "name": "SpecificChart",
                                            "value": "Line"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "isOptional": true
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsPart",
                                    "settings": {
                                        "content": {
                                            "PartTitle": "Pageviews last 24h",
                                            "PartSubTitle": "[parameters('appInsightsName')]"
                                        }
                                    },
                                    "asset": {
                                        "idInputName": "ComponentId",
                                        "type": "ApplicationInsights"
                                    }
                                }
                            },
                            "1": {
                                "position": {
                                    "x": 5,
                                    "y": 0,
                                    "rowSpan": 4,
                                    "colSpan": 5
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "ComponentId",
                                            "value": {
                                                "SubscriptionId": "[variables('subscriptionId')]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('appInsightsName')]",
                                                "ResourceId": "[variables('appInsightsResourceId')]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "value": "pageViews\n| parse url with * '#' SubPage \n| project timestamp, SubPage, duration \n| summarize count() by SubPage\n| render piechart  \n"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "value": "P1D"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "value": {
                                                "xAxis": {
                                                    "name": "SubPage",
                                                    "type": "String"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "count_",
                                                        "type": "Int64"
                                                    }
                                                ],
                                                "splitBy": [],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "PartTitle",
                                            "value": "Analytics"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "value": "[parameters('appInsightsName')]"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "value": "components"
                                        },
                                        {
                                            "name": "ControlType",
                                            "value": "AnalyticsDonut"
                                        },
                                        {
                                            "name": "SpecificChart",
                                            "isOptional": true
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsPart",
                                    "settings": {
                                        "content": {
                                            "PartTitle": "Pageviews by Page",
                                            "PartSubTitle": "[parameters('appInsightsName')]"
                                        }
                                    },
                                    "asset": {
                                        "idInputName": "ComponentId",
                                        "type": "ApplicationInsights"
                                    }
                                }
                            },
                            "2": {
                                "position": {
                                    "x": 10,
                                    "y": 0,
                                    "rowSpan": 4,
                                    "colSpan": 5
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "ComponentId",
                                            "value": {
                                                "SubscriptionId": "[variables('subscriptionId')]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('appInsightsName')]",
                                                "ResourceId": "[variables('appInsightsResourceId')]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "value": "exceptions\n| summarize Exceptions=count(itemType) by bin(timestamp, 1h)\n| render barchart  \n"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "value": "P1D"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "value": {
                                                "xAxis": {
                                                    "name": "timestamp",
                                                    "type": "DateTime"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "Exceptions",
                                                        "type": "Int64"
                                                    }
                                                ],
                                                "splitBy": [],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "PartTitle",
                                            "value": "Analytics"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "value": "[parameters('appInsightsName')]"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "value": "components"
                                        },
                                        {
                                            "name": "ControlType",
                                            "value": "AnalyticsChart"
                                        },
                                        {
                                            "name": "SpecificChart",
                                            "value": "Bar"
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsPart",
                                    "settings": {
                                        "content": {
                                            "PartTitle": "Exceptions",
                                            "PartSubTitle": "[parameters('appInsightsName')]"
                                        }
                                    },
                                    "asset": {
                                        "idInputName": "ComponentId",
                                        "type": "ApplicationInsights"
                                    }
                                }
                            },
                            "3": {
                                "position": {
                                    "x": 0,
                                    "y": 4,
                                    "rowSpan": 4,
                                    "colSpan": 5
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "ComponentId",
                                            "value": {
                                                "SubscriptionId": "[variables('subscriptionId')]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('appInsightsName')]",
                                                "ResourceId": "[variables('appInsightsResourceId')]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "value": "pageViews\n| parse url with * '#' SubPage \n| project timestamp, SubPage, duration, performanceBucket  \n| summarize Pageviews = count(performanceBucket) by performanceBucket\n| render barchart \n"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "value": "P1D"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "value": {
                                                "xAxis": {
                                                    "name": "performanceBucket",
                                                    "type": "String"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "Pageviews",
                                                        "type": "Int64"
                                                    }
                                                ],
                                                "splitBy": [],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "PartTitle",
                                            "value": "Analytics"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "value": "[parameters('appInsightsName')]"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "value": "components"
                                        },
                                        {
                                            "name": "ControlType",
                                            "value": "AnalyticsChart"
                                        },
                                        {
                                            "name": "SpecificChart",
                                            "value": "Bar"
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsPart",
                                    "settings": {
                                        "content": {
                                            "PartTitle": "Page performance",
                                            "PartSubTitle": "[parameters('appInsightsName')]"
                                        }
                                    },
                                    "asset": {
                                        "idInputName": "ComponentId",
                                        "type": "ApplicationInsights"
                                    }
                                }
                            },
                            "4": {
                                "position": {
                                    "x": 5,
                                    "y": 4,
                                    "rowSpan": 4,
                                    "colSpan": 5
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "ComponentId",
                                            "value": {
                                                "SubscriptionId": "[variables('subscriptionId')]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('appInsightsName')]",
                                                "ResourceId": "[variables('appInsightsResourceId')]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "value": "pageViews\n| project refUri = customDimensions.refUri\n| extend parsedUrl = parse_url(tostring(refUri))\n| extend pathParts = split(parsedUrl.Path, '/')\n| extend Project = case(parsedUrl.Host == \"dev.azure.com\", pathParts[2], pathParts[1]) \n| summarize count() by tostring(Project)\n| render piechart "
                                        },
                                        {
                                            "name": "TimeRange",
                                            "value": "P1D"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "value": {
                                                "xAxis": {
                                                    "name": "Project",
                                                    "type": "String"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "count_",
                                                        "type": "Int64"
                                                    }
                                                ],
                                                "splitBy": [],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "PartTitle",
                                            "value": "Analytics"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "value": "[parameters('appInsightsName')]"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "value": "components"
                                        },
                                        {
                                            "name": "ControlType",
                                            "value": "AnalyticsDonut"
                                        },
                                        {
                                            "name": "SpecificChart",
                                            "isOptional": true
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsPart",
                                    "settings": {
                                        "content": {
                                            "PartTitle": "Pageviews by Project",
                                            "PartSubTitle": "[parameters('appInsightsName')]"
                                        }
                                    },
                                    "asset": {
                                        "idInputName": "ComponentId",
                                        "type": "ApplicationInsights"
                                    }
                                }
                            },
                            "5": {
                                "position": {
                                    "x": 10,
                                    "y": 4,
                                    "rowSpan": 4,
                                    "colSpan": 5
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "ComponentId",
                                            "value": {
                                                "SubscriptionId": "[variables('subscriptionId')]",
                                                "ResourceGroup": "[resourceGroup().name]",
                                                "Name": "[parameters('appInsightsName')]",
                                                "ResourceId": "[variables('appInsightsResourceId')]"
                                            }
                                        },
                                        {
                                            "name": "Query",
                                            "value": "requests | where success == \"False\" \n| summarize Failures=count() by name, bin(timestamp, 1h) \n| render barchart   \n"
                                        },
                                        {
                                            "name": "TimeRange",
                                            "value": "P1D"
                                        },
                                        {
                                            "name": "Dimensions",
                                            "value": {
                                                "xAxis": {
                                                    "name": "timestamp",
                                                    "type": "DateTime"
                                                },
                                                "yAxis": [
                                                    {
                                                        "name": "Failures",
                                                        "type": "Int64"
                                                    }
                                                ],
                                                "splitBy": [
                                                    {
                                                        "name": "name",
                                                        "type": "String"
                                                    }
                                                ],
                                                "aggregation": "Sum"
                                            }
                                        },
                                        {
                                            "name": "PartTitle",
                                            "value": "Analytics"
                                        },
                                        {
                                            "name": "PartSubTitle",
                                            "value": "[parameters('appInsightsName')]"
                                        },
                                        {
                                            "name": "resourceTypeMode",
                                            "value": "components"
                                        },
                                        {
                                            "name": "ControlType",
                                            "value": "AnalyticsChart"
                                        },
                                        {
                                            "name": "SpecificChart",
                                            "value": "Bar"
                                        }
                                    ],
                                    "type": "Extension/AppInsightsExtension/PartType/AnalyticsPart",
                                    "settings": {
                                        "content": {
                                            "PartTitle": "Failed requests by Function",
                                            "PartSubTitle": "[parameters('appInsightsName')]"
                                        }
                                    },
                                    "asset": {
                                        "idInputName": "ComponentId",
                                        "type": "ApplicationInsights"
                                    }
                                }
                            },
                            "6": {
                                "position": {
                                    "x": 0,
                                    "y": 8,
                                    "colSpan": 8,
                                    "rowSpan": 6
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "options",
                                            "value": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - buildcompleted",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - buildcompleted"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - buildcompleted-poison",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - buildcompleted-poison"
                                                            }
                                                        }
                                                    ],
                                                    "title": "Avg Queue length - buildcompleted and Avg Queue length - buildcompleted-poison",
                                                    "titleKind": 1,
                                                    "visualization": {
                                                        "chartType": 2,
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": 2,
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": 2
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": 1
                                                            }
                                                        }
                                                    }
                                                },
                                                "version": 2
                                            }
                                        },
                                        {
                                            "name": "sharedTimeRange",
                                            "isOptional": true
                                        }
                                    ],
                                    "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                    "settings": {
                                        "content": {
                                            "options": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - buildcompleted",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - buildcompleted"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - buildcompleted-poison",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - buildcompleted-poison"
                                                            }
                                                        }
                                                    ],
                                                    "title": "Avg Queue length - buildcompleted and Avg Queue length - buildcompleted-poison",
                                                    "titleKind": 1,
                                                    "visualization": {
                                                        "chartType": 2,
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": 2,
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": 2
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": 1
                                                            }
                                                        },
                                                        "disablePinning": true
                                                    },
                                                    "filterCollection": {
                                                        "filters": []
                                                    }
                                                },
                                                "version": 2
                                            }
                                        }
                                    }
                                }
                            },
                            "7": {
                                "position": {
                                    "x": 8,
                                    "y": 8,
                                    "colSpan": 8,
                                    "rowSpan": 6
                                },
                                "metadata": {
                                    "inputs": [
                                        {
                                            "name": "options",
                                            "value": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - releasedeploymentcompleted",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - releasedeploymentcompleted"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - releasedeploymentcompleted-poison",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - releasedeploymentcompleted-poison"
                                                            }
                                                        }
                                                    ],
                                                    "titleKind": 1,
                                                    "title": "Avg Queue length - releasedeploymentcompleted and Avg Queue length - releasedeploymentcompleted-poison",
                                                    "visualization": {
                                                        "chartType": 2,
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": 2,
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": 2
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": 1
                                                            }
                                                        }
                                                    }
                                                },
                                                "version": 2
                                            }
                                        },
                                        {
                                            "name": "sharedTimeRange",
                                            "isOptional": true
                                        }
                                    ],
                                    "type": "Extension/HubsExtension/PartType/MonitorChartPart",
                                    "settings": {
                                        "content": {
                                            "options": {
                                                "chart": {
                                                    "metrics": [
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - releasedeploymentcompleted",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - releasedeploymentcompleted"
                                                            }
                                                        },
                                                        {
                                                            "resourceMetadata": {
                                                                "id": "[variables('appInsightsResourceId')]"
                                                            },
                                                            "name": "Queue length - releasedeploymentcompleted-poison",
                                                            "aggregationType": 4,
                                                            "namespace": "azure.applicationinsights",
                                                            "metricVisualization": {
                                                                "displayName": "Queue length - releasedeploymentcompleted-poison"
                                                            }
                                                        }
                                                    ],
                                                    "titleKind": 1,
                                                    "title": "Avg Queue length - releasedeploymentcompleted and Avg Queue length - releasedeploymentcompleted-poison",
                                                    "visualization": {
                                                        "chartType": 2,
                                                        "legendVisualization": {
                                                            "isVisible": true,
                                                            "position": 2,
                                                            "hideSubtitle": false
                                                        },
                                                        "axisVisualization": {
                                                            "x": {
                                                                "isVisible": true,
                                                                "axisType": 2
                                                            },
                                                            "y": {
                                                                "isVisible": true,
                                                                "axisType": 1
                                                            }
                                                        },
                                                        "disablePinning": true
                                                    },
                                                    "filterCollection": {
                                                        "filters": []
                                                    }
                                                },
                                                "version": 2
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    }
                },
                "metadata": {
                    "model": {
                        "timeRange": {
                            "value": {
                                "relative": {
                                    "duration": 24,
                                    "timeUnit": 1
                                }
                            },
                            "type": "MsPortalFx.Composition.Configuration.ValueTypes.TimeRange"
                        }
                    }
                }
            }
        }
    ]
}